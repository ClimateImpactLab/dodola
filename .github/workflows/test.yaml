name: Test

on:
  push:
    branches:
    - "main"
  pull_request:
    branches:
    - "main"

jobs:
  codequality:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - name: Setup Python
      uses: actions/setup-python@v2
    - name: Install dependencies
      run: |
        pip install flake8 black
    - name: Test code quality
      run: |
        make format-check

  container-tests:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - name: Build container
      run: |
        docker build . -t dodola:dev
    - name: Test package
      run: |
        docker run -w /opt/dodola --name testcontainer dodola:dev \
          pytest -v --pyargs dodola --cov dodola --cov-report term-missing --cov-report xml
        docker cp testcontainer:/opt/dodola/coverage.xml ./coverage.xml
    - name: Test CLI
      run: |
        docker run dodola:dev dodola --help
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v2
